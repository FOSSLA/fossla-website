---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { Icon } from "astro-icon/components";
import { getCollection } from "astro:content";

const allPosts = (await getCollection("blog")).sort((a, b) => b.data.date.getTime() - a.data.date.getTime());
const categoryParam = Astro.url.searchParams.get("category") ?? "All";
const categories = ["All", ...new Set(allPosts.map((post) => post.data.category))];
const filteredPosts = categoryParam === "All" ? allPosts : allPosts.filter((post) => post.data.category === categoryParam);
const featured = filteredPosts.find((post) => post.data.featured) ?? filteredPosts[0];
const remaining = featured ? filteredPosts.filter((post) => post.id !== featured.id) : [];
---
<BaseLayout title="Community Blog" description="Stories, tutorials, and insights from the FOSS LA community.">
  <section class="container mx-auto px-4 pt-24 pb-20">
    <div class="mx-auto mb-16 max-w-4xl text-center">
      <h1 class="mb-6 text-4xl font-bold md:text-5xl">
        Community <span class="text-primary">Blog</span>
      </h1>
      <p class="text-xl text-muted-foreground">Stories, tutorials, and insights from the FOSS LA community.</p>
    </div>

    <div class="mb-12 flex flex-wrap justify-center gap-2">
      {categories.map((category) => {
        const isActive = category === categoryParam;
        const url = category === "All" ? "/blog" : `/blog?category=${encodeURIComponent(category)}`;
        return (
          <a
            href={url}
            class={`rounded px-4 py-2 text-sm font-semibold transition ${
              isActive ? "border border-primary bg-primary text-primary-foreground" : "border border-border text-foreground hover:border-primary"
            }`}
          >
            {category}
          </a>
        );
      })}
    </div>

    {featured && (
      <article class="mb-12 rounded border border-primary/30 bg-gradient-to-br from-primary/5 to-transparent p-8">
        <div class="mb-3 flex items-center gap-2 text-xs">
          {featured.data.featured && (
            <span class="rounded bg-primary/20 px-2 py-1 font-semibold text-primary">Featured</span>
          )}
          <span class="rounded bg-primary/10 px-2 py-1 font-semibold text-primary">{featured.data.category}</span>
        </div>
        <h2 class="mb-4 text-3xl font-bold text-foreground">
          <a href={`/blog/${featured.slug}`} class="transition hover:text-primary">{featured.data.title}</a>
        </h2>
        <p class="mb-6 text-muted-foreground">{featured.data.description}</p>
        <div class="mb-6 flex flex-wrap items-center gap-4 text-sm text-muted-foreground">
          <span class="inline-flex items-center gap-2">
            <Icon name="lucide:user" class="h-4 w-4 text-primary" />
            {featured.data.author}
          </span>
          <span class="inline-flex items-center gap-2">
            <Icon name="lucide:calendar" class="h-4 w-4 text-primary" />
            {featured.data.date.toLocaleDateString()}
          </span>
          {featured.data.readTime && <span>{featured.data.readTime}</span>}
        </div>
        <a href={`/blog/${featured.slug}`} class="inline-flex items-center rounded border border-primary bg-primary px-6 py-2 text-sm font-semibold text-primary-foreground">
          Read Full Article
          <Icon name="lucide:arrow-right" class="ml-2 h-4 w-4" />
        </a>
      </article>
    )}

    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
      {remaining.map((post) => (
        <article class="flex flex-col rounded border border-border bg-card/40 p-6 transition hover:border-primary/50">
          <span class="mb-3 inline-flex rounded bg-primary/10 px-2 py-1 text-xs font-semibold text-primary">{post.data.category}</span>
          <h3 class="mb-3 text-xl font-semibold">
            <a href={`/blog/${post.slug}`} class="transition hover:text-primary">{post.data.title}</a>
          </h3>
          <p class="mb-4 flex-1 text-sm text-muted-foreground">{post.data.description}</p>
          <div class="mb-4 text-xs text-muted-foreground">
            <div class="flex items-center gap-2">
              <Icon name="lucide:user" class="h-3 w-3 text-primary" />
              {post.data.author}
            </div>
            <div class="mt-2 flex items-center gap-2">
              <Icon name="lucide:calendar" class="h-3 w-3 text-primary" />
              {post.data.date.toLocaleDateString()}
            </div>
          </div>
          <a href={`/blog/${post.slug}`} class="inline-flex items-center text-sm text-primary">
            Read more
            <Icon name="lucide:arrow-right" class="ml-1 h-4 w-4" />
          </a>
        </article>
      ))}
    </div>
  </section>
</BaseLayout>
